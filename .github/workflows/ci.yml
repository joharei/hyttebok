name: Hyttebok CI

on:
  push:
  pull_request:
    branches: 
      - master

jobs:
  build_backend:
    name: Build backend

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1

    - name: Set up JDK 1.13
      uses: actions/setup-java@v1
      with:
        java-version: 1.13

    - name: Build with Gradle
      working-directory: backend
      run: ./gradlew build
  
  deploy_backend:
    name: Deploy backend
    if: github.ref == 'refs/heads/master'
    
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v1
        
      - name: Deploy to Heroku
        env:
          heroku_token: ${{ secrets.HEROKU_TOKEN }}
        run: |
          git remote add heroku https://heroku:$(heroku_token)@git.heroku.com/hyttebok.git
          git subtree split --prefix backend -b heroku
          git push -f heroku heroku:master
          git branch -D heroku
